name: Setup Vercel Project

on:
  workflow_call:
    outputs:
      org-id:
        description: 'Vercel Org ID'
        value: ${{ jobs.setup.outputs.org-id }}
      project-id:
        description: 'Vercel Project ID'
        value: ${{ jobs.setup.outputs.project-id }}

jobs:
  # ============================================
  # è®¾ç½® Vercel é¡¹ç›®ï¼ˆèŽ·å– Org ID å’Œåˆ›å»ºé¡¹ç›®ï¼‰
  # ============================================
  setup:
    name: Setup Vercel Project
    runs-on: ubuntu-latest
    outputs:
      org-id: ${{ steps.setup.outputs.org-id }}
      project-id: ${{ steps.setup.outputs.project-id }}
    steps:
      - name: Get or create Vercel project
        id: setup
        run: |
          # è®¾ç½®é»˜è®¤å€¼
          ORG_ID="${{ secrets.VERCEL_ORG_ID }}"
          PROJECT_ID="${{ secrets.VERCEL_PROJECT_ID }}"
          
          # å¦‚æžœ Org ID ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨èŽ·å–
          if [ -z "$ORG_ID" ]; then
            echo "ðŸ” Auto-detecting VERCEL_ORG_ID..."
            # èŽ·å–ç”¨æˆ·ä¿¡æ¯
            USER_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              https://api.vercel.com/v2/user)
            
            ORG_ID=$(echo "$USER_RESPONSE" | jq -r '.user.id // empty')
            
            # å¦‚æžœæ— æ³•èŽ·å–ç”¨æˆ· IDï¼Œå°è¯•èŽ·å–å›¢é˜Ÿ
            if [ -z "$ORG_ID" ] || [ "$ORG_ID" = "null" ]; then
              TEAMS_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
                https://api.vercel.com/v2/teams)
              ORG_ID=$(echo "$TEAMS_RESPONSE" | jq -r '.teams[0].id // empty')
              if [ -n "$ORG_ID" ] && [ "$ORG_ID" != "null" ] && [[ ! "$ORG_ID" =~ ^team_ ]]; then
                ORG_ID="team_$ORG_ID"
              fi
            fi
            
            if [ -z "$ORG_ID" ] || [ "$ORG_ID" = "null" ]; then
              echo "âŒ Error: Could not determine VERCEL_ORG_ID. Please set it in GitHub Secrets."
              exit 1
            fi
            
            echo "âœ… Auto-detected VERCEL_ORG_ID: $ORG_ID"
          else
            echo "âœ… Using provided VERCEL_ORG_ID: $ORG_ID"
          fi
          
          # å¦‚æžœ Project ID ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é¡¹ç›®
          if [ -z "$PROJECT_ID" ]; then
            echo "ðŸ“¦ Creating new Vercel project..."
            
            # ä»Žä»“åº“åç§°èŽ·å–é¡¹ç›®åç§°ï¼ˆç§»é™¤ .github.io åŽç¼€ï¼‰
            PROJECT_NAME="${GITHUB_REPOSITORY##*/}"
            PROJECT_NAME="${PROJECT_NAME%.github.io}"
            
            # ä½¿ç”¨ Vercel API åˆ›å»ºé¡¹ç›®
            CREATE_RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"$PROJECT_NAME\",
                \"framework\": null
              }" \
              "https://api.vercel.com/v9/projects?teamId=${ORG_ID}")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            ERROR=$(echo "$CREATE_RESPONSE" | jq -r '.error // empty')
            if [ -n "$ERROR" ] && [ "$ERROR" != "null" ]; then
              echo "âŒ Error creating project: $ERROR"
              echo "Response: $CREATE_RESPONSE"
              exit 1
            fi
            
            PROJECT_ID=$(echo "$CREATE_RESPONSE" | jq -r '.id // empty')
            
            if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
              echo "âŒ Error: Failed to create project"
              echo "Response: $CREATE_RESPONSE"
              exit 1
            fi
            
            echo "âœ… Created new project with ID: $PROJECT_ID"
            echo ""
            echo "::notice title=é¡¹ç›®å·²è‡ªåŠ¨åˆ›å»º::è¯·å°†ä»¥ä¸‹ä¿¡æ¯æ·»åŠ åˆ° GitHub Secrets (Settings â†’ Secrets â†’ Actions):"
            echo "VERCEL_PROJECT_ID=$PROJECT_ID"
            echo "VERCEL_ORG_ID=$ORG_ID"
            echo ""
          else
            echo "âœ… Using existing project: $PROJECT_ID"
          fi
          
          # è¾“å‡ºåˆ° GitHub Actions
          echo "org-id=$ORG_ID" >> $GITHUB_OUTPUT
          echo "project-id=$PROJECT_ID" >> $GITHUB_OUTPUT

